<!--pages/mine/mine.wxml-->
<view class="page-container">
  <navigation-bar title="ğŸ‘¤ ç”¨æˆ·è¯¦æƒ…" back="{{false}}" color="black" background="#FFF"></navigation-bar>
  <scroll-view class="scrollarea" scroll-y type="list">
    <view class="modal-body">
      <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
      <view class="user-info-section">
        <view class="user-avatar-section">
          <view class="user-avatar-large {{!userDetail.personaAvatarUrl ? 'default' : ''}}" id="mainUserAvatar" bindtap="onAvatarTap">
            <image wx:if="{{userDetail.personaAvatarUrl}}" src="{{userDetail.personaAvatarUrl}}" mode="aspectFill" />
            <text wx:else>é»˜è®¤</text>
          </view>
          <view class="user-basic-info">
            <text class="user-name">{{userDetail.personaName || userDetail.username || 'æœªè®¾ç½®æ˜µç§°'}}</text>
            <view class="username-line">
              <text class="username">@{{userDetail.username || 'æœªè®¾ç½®'}}</text>
              <text wx:if="{{!userDetail.username}}" class="account-action-link bind-account-link" bindtap="onBindAccount">å…³è”å·²æœ‰è´¦å·</text>
            </view>
          </view>
        </view>
        <view class="user-bio">
          <text class="bio-text {{bioExpanded ? 'expanded' : ''}}" data-full-text="{{userDetail.personaBio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}">
            {{userDetail.bioDisplayText || userDetail.personaBio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}
          </text>
          <view class="bio-toggle-btn" wx:if="{{userDetail.bioExpanded !== undefined}}" bindtap="onToggleBio" data-target="user">
            {{userDetail.bioExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}
          </view>
        </view>

        <!-- ä¸ªäººç®€ä»‹å±•ç¤ºå¼€å…³ -->
        <view class="show-bio-toggle">
          <view class="toggle-content">
            <view class="toggle-label">
              <view class="toggle-title-row">
                <text class="toggle-title">å‘AIå±•ç¤ºä¸ªäººç®€ä»‹</text>
                <view class="info-icon" bindtap="onShowBioInfo">?</view>
              </view>
              <text class="toggle-description">å¼€å¯åAIä¼šäº†è§£ä½ çš„ä¸ªäººè®¾å®š</text>
            </view>
          </view>
          <view class="toggle-switch {{userDetail.showBio ? 'active' : ''}}" bindtap="onToggleShowBio">
            <view class="switch-button"></view>
          </view>
        </view>

        <!-- åŠŸèƒ½è¯´æ˜å¼¹çª— -->
        <view class="info-modal {{showBioInfoModal ? 'show' : ''}}" wx:if="{{showBioInfoModal}}" bindtap="onCloseBioInfoModal">
          <view class="modal-content" catchtap="">
            <view class="modal-header">
              <text class="modal-title">ä¸ªäººç®€ä»‹è®¾ç½®è¯´æ˜</text>
              <view class="close-btn" bindtap="onCloseBioInfoModal">Ã—</view>
            </view>
            <view class="modal-body">
              <text class="modal-text">é€šè¿‡ä¸ªäººç®€ä»‹è‡ªç”±è®¾å®šä½ çš„å–œå¥½æˆ–äººè®¾ï¼Œå¼€å¯åAIä¼šæ ¹æ®ä½ çš„è®¾å®šè°ƒæ•´å›ç­”é£æ ¼ã€‚</text>
              <text class="modal-examples">ä¾‹å¦‚ï¼š</text>
              <text class="modal-example">"æˆ‘ä¸å–œæ¬¢å•°å—¦ï¼Œè¯·é«˜åº¦æ¦‚æ‹¬æ€§çš„å›ç­”é—®é¢˜"</text>
              <text class="modal-example">"æˆ‘æ˜¯ä¸€ä¸ªç»ä¸–é«˜æ‰‹ï¼Œä»»ä½•äººå¯¹æˆ‘éƒ½å……æ»¡äº†æ•¬é‡ä¸ç•æƒ§"</text>
            </view>
          </view>
        </view>

        <view class="user-footer-actions">
        </view>
      </view>

      <!-- è¯¦æƒ…ä¿¡æ¯åŒºåŸŸ -->
      <view class="detail-section">
        <text class="section-title">è´¦æˆ·ä¿¡æ¯</text>

        <!-- é‚®ç®±ç®¡ç†ç»„ä»¶ -->
        <email-component
          currentEmail="{{userDetail.email}}"
          action="{{userDetail.email ? 'unbind' : 'bind'}}"
          bind:success="onEmailComponentSuccess"
        ></email-component>
      </view>

      <!-- èº«ä»½ç®¡ç†åŒºåŸŸ -->
      <view class="personas-section">
        <view class="personas-header">
          <text class="personas-title">èº«ä»½ç®¡ç†</text>
          <view class="add-persona-btn" bindtap="onAddPersona">
            <text>+</text>
            <text>æ–°å¢èº«ä»½</text>
          </view>
        </view>

        <view class="personas-list">
          <!-- å½“å‰èº«ä»½ -->
          <view class="persona-card current {{currentPersonaActive ? 'active' : ''}}" bindtap="onCurrentPersonaTap">
            <view class="persona-header">
              <view class="persona-info">
                <view class="persona-avatar-small {{!userDetail.personaAvatarUrl ? 'default' : ''}}" id="currentPersonaAvatar">
                  <image wx:if="{{userDetail.personaAvatarUrl}}" src="{{userDetail.personaAvatarUrl}}" mode="aspectFill" />
                  <text wx:else>é»˜è®¤</text>
                </view>
                <view class="persona-details">
                  <view class="persona-name-row">
                    <text class="persona-name">{{userDetail.personaName || 'æœªè®¾ç½®æ˜µç§°'}}</text>
                    <view class="current-badge">
                      <text class="star-icon">â­</text>
                      <text>å½“å‰é»˜è®¤</text>
                    </view>
                  </view>
                  <text class="persona-bio">
                    <text class="bio-text {{userDetail.currentBioExpanded ? 'expanded' : ''}}" data-full-text="{{userDetail.personaBio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}">
                      {{userDetail.currentBioDisplayText || userDetail.personaBio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}
                    </text>
                  </text>
                  <view class="bio-toggle-btn" wx:if="{{userDetail.currentBioExpanded !== undefined}}" bindtap="onToggleBio" data-target="currentPersona">
                    {{userDetail.currentBioExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}
                  </view>
                </view>
              </view>
              <view class="persona-actions">
                <view class="action-icon-btn edit" title="ç¼–è¾‘å½“å‰èº«ä»½" bindtap="onEditCurrentPersona">âœï¸</view>
              </view>
            </view>
          </view>

          <!-- å…¶ä»–èº«ä»½ -->
          <block wx:if="{{userDetail.otherPersonas && userDetail.otherPersonas.length > 0}}">
            <view
              class="persona-card {{otherPersonasActive[index] ? 'active' : ''}}"
              wx:for="{{userDetail.otherPersonas}}"
              wx:key="personaId"
              data-persona-id="{{item.personaId}}"
              data-index="{{index}}"
              bindtap="onPersonaCardTap"
            >
              <view class="persona-header">
                <view class="persona-info">
                  <view class="persona-avatar-small {{!item.avatarUrl ? 'default' : ''}}">
                    <image wx:if="{{item.avatarUrl}}" src="{{item.avatarUrl}}" mode="aspectFill" />
                    <text wx:else>é»˜è®¤</text>
                  </view>
                  <view class="persona-details">
                    <view class="persona-name-row">
                      <text class="persona-name">{{item.name}}</text>
                    </view>
                    <text class="persona-bio">
                      <text class="bio-text {{item.bioExpanded ? 'expanded' : ''}}" data-full-text="{{item.bio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}">
                        {{item.bioDisplayText || item.bio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}
                      </text>
                    </text>
                    <view class="bio-toggle-btn" wx:if="{{item.bioExpanded !== undefined}}" bindtap="onToggleOtherBio" data-persona-id="{{item.personaId}}">
                      {{item.bioExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}
                    </view>
                  </view>
                </view>
                <view class="persona-actions">
                  <view class="action-icon-btn set-default" title="è®¾ä¸ºé»˜è®¤èº«ä»½" bindtap="onSetDefaultPersona" data-persona="{{item}}">â­</view>
                  <view class="action-icon-btn edit" title="ç¼–è¾‘" bindtap="onEditPersona" data-persona="{{item}}">âœï¸</view>
                  <view class="action-icon-btn delete" title="åˆ é™¤" bindtap="onDeletePersona" data-persona="{{item}}">ğŸ—‘ï¸</view>
                </view>
              </view>
            </view>
          </block>
          <view wx:else class="empty-personas">
            <text>æš‚æ— å…¶ä»–èº«ä»½</text>
          </view>
        </view>
      </view>

    </view>
  </scroll-view>

  <!-- ç¼–è¾‘èº«ä»½å¼¹çª—ç»„ä»¶ -->
  <edit-persona-modal
    visible="{{showEditPersonaModal}}"
    mode="{{editPersonaMode}}"
    personaData="{{editPersonaData}}"
    bind:close="onCloseEditPersonaModal"
    bind:success="onEditPersonaSuccess"
  ></edit-persona-modal>
</view>












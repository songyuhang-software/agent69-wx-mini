<!--pages/mine/mine.wxml-->
<navigation-bar title="ğŸ‘¤ ç”¨æˆ·è¯¦æƒ…" back="{{false}}" color="black" background="#FFF"></navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="modal-body">
    <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
    <view class="user-info-section">
      <view class="user-avatar-section">
        <view class="user-avatar-large {{!userDetail.personaAvatarUrl ? 'default' : ''}}" id="mainUserAvatar" bindtap="onAvatarTap">
          <image wx:if="{{userDetail.personaAvatarUrl}}" src="{{userDetail.personaAvatarUrl}}" mode="aspectFill" />
          <text wx:else>é»˜è®¤</text>
        </view>
        <view class="user-basic-info">
          <text class="user-name">{{userDetail.personaName || userDetail.username || 'æœªè®¾ç½®æ˜µç§°'}}</text>
          <view class="username-line">
            <text class="username">@{{userDetail.username || 'æœªè®¾ç½®'}}</text>
            <text wx:if="{{!userDetail.username}}" class="account-action-link" bindtap="onSupplementAccount">è¡¥å…¨è´¦å·</text>
            <text wx:else class="account-action-links">
              <text class="account-action-link" bindtap="onChangePassword">ä¿®æ”¹å¯†ç </text>
            </text>
          </view>
        </view>
      </view>
      <view class="user-bio">
        <text class="bio-text" data-full-text="{{userDetail.personaBio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}">{{userDetail.personaBio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}</text>
      </view>
      <view class="user-footer-actions">
        <view class="logout-link" bindtap="onLogout">é€€å‡ºç™»å½•</view>
      </view>
    </view>

    <!-- è¯¦æƒ…ä¿¡æ¯åŒºåŸŸ -->
    <view class="detail-section">
      <text class="section-title">è´¦æˆ·ä¿¡æ¯</text>
      
      <!-- é‚®ç®±ç®¡ç†ç»„ä»¶ -->
      <email-component
        currentEmail="{{userDetail.email}}"
        action="{{userDetail.email ? 'unbind' : 'bind'}}"
        bind:success="onEmailComponentSuccess"
      ></email-component>
    </view>

    <!-- èº«ä»½ç®¡ç†åŒºåŸŸ -->
    <view class="personas-section">
      <view class="personas-header">
        <text class="personas-title">èº«ä»½ç®¡ç†</text>
        <view class="add-persona-btn" bindtap="onAddPersona">
          <text>+</text>
          <text>æ–°å¢èº«ä»½</text>
        </view>
      </view>

      <view class="personas-list">
        <!-- å½“å‰èº«ä»½ -->
        <view class="persona-card current">
          <view class="persona-header">
            <view class="persona-info">
              <view class="persona-avatar-small {{!userDetail.personaAvatarUrl ? 'default' : ''}}" id="currentPersonaAvatar">
                <image wx:if="{{userDetail.personaAvatarUrl}}" src="{{userDetail.personaAvatarUrl}}" mode="aspectFill" />
                <text wx:else>é»˜è®¤</text>
              </view>
              <view class="persona-details">
                <view class="persona-name-row">
                  <text class="persona-name">{{userDetail.personaName || 'æœªè®¾ç½®æ˜µç§°'}}</text>
                  <view class="current-badge">
                    <text class="star-icon">â­</text>
                    <text>å½“å‰é»˜è®¤</text>
                  </view>
                </view>
                <text class="persona-bio">
                  <text class="bio-text" data-full-text="{{userDetail.personaBio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}">{{userDetail.personaBio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}</text>
                </text>
              </view>
            </view>
            <view class="persona-actions">
              <view class="action-icon-btn edit" title="ç¼–è¾‘å½“å‰èº«ä»½" bindtap="onEditCurrentPersona">âœï¸</view>
            </view>
          </view>
        </view>

        <!-- å…¶ä»–èº«ä»½ -->
        <block wx:if="{{userDetail.otherPersonas && userDetail.otherPersonas.length > 0}}">
          <view class="persona-card" wx:for="{{userDetail.otherPersonas}}" wx:key="personaId" data-persona-id="{{item.personaId}}">
            <view class="persona-header">
              <view class="persona-info">
                <view class="persona-avatar-small {{!item.avatarUrl ? 'default' : ''}}">
                  <image wx:if="{{item.avatarUrl}}" src="{{item.avatarUrl}}" mode="aspectFill" />
                  <text wx:else>é»˜è®¤</text>
                </view>
                <view class="persona-details">
                  <view class="persona-name-row">
                    <text class="persona-name">{{item.name}}</text>
                  </view>
                  <text class="persona-bio">
                    <text class="bio-text" data-full-text="{{item.bio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}">{{item.bio || 'è¿™ä¸ªäººå¾ˆæ‡’,ä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...'}}</text>
                  </text>
                </view>
              </view>
              <view class="persona-actions">
                <view class="action-icon-btn set-default" title="è®¾ä¸ºé»˜è®¤èº«ä»½" bindtap="onSetDefaultPersona" data-persona="{{item}}">â­</view>
                <view class="action-icon-btn edit" title="ç¼–è¾‘" bindtap="onEditPersona" data-persona="{{item}}">âœï¸</view>
                <view class="action-icon-btn delete" title="åˆ é™¤" bindtap="onDeletePersona" data-persona="{{item}}">ğŸ—‘ï¸</view>
              </view>
            </view>
          </view>
        </block>
        <view wx:else class="empty-personas">
          <text>æš‚æ— å…¶ä»–èº«ä»½</text>
        </view>
      </view>
    </view>

    <!-- è´¦å·æ“ä½œåŒºåŸŸ -->
    <view class="account-actions-section">
      <view class="account-actions-toggle {{accountActionsExpanded ? 'active' : ''}}" id="accountActionsToggle" bindtap="onToggleAccountActions">
        <text class="toggle-text">è´¦å·ä¸å®‰å…¨</text>
        <text class="toggle-icon">â–¼</text>
      </view>
      <view class="account-actions-content {{accountActionsExpanded ? 'show' : ''}}" id="accountActionsContent" wx:if="{{accountActionsExpanded}}">
        <view class="account-action-item delete-account-item" id="deleteAccountBtn" bindtap="onDeleteAccount">
          <text class="action-label">æ³¨é”€è´¦å·</text>
          <text class="action-arrow">â€º</text>
        </view>
      </view>
    </view>
  </view>
</scroll-view>

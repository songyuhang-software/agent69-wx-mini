<!--index.wxml-->
<view class="container">
  <!-- 顶部标题栏 -->
  <view class="header" style="padding-top: {{safeAreaTop + 8}}px;">
    <text class="header-title">智能笔记</text>
  </view>

  <!-- 状态提示 -->
  <view wx:if="{{statusVisible}}" class="status {{statusType}}" style="top: {{headerHeight}}px;">
    <text>{{statusMessage}}</text>
  </view>

  <!-- 聊天消息区域 -->
  <scroll-view
    class="chat-container"
    style="top: {{headerHeight}}px;"
    scroll-y
    scroll-into-view="{{scrollToView}}"
    scroll-with-animation="{{true}}"
    bindscrolltoupper="onScrollToUpper"
    upper-threshold="50"
    bindtouchstart="onTouchStart"
    bindtouchmove="onTouchMove"
    bindtouchend="onTouchEnd"
  >
    <view class="messages-wrapper">
      <!-- 加载更多提示 -->
      <view wx:if="{{isLoadingMore}}" class="loading-more">
        <text>加载中...</text>
      </view>

      <!-- 消息列表 -->
      <view
        wx:for="{{messages}}"
        wx:key="id"
        id="msg-{{item.id}}"
      >
        <!-- 时间标签 -->
        <view wx:if="{{item.type === 'time-label'}}" class="time-label">
          <text>{{item.timeText}}</text>
        </view>

        <!-- 消息内容 -->
        <view wx:else class="message-wrapper {{item.role}}-wrapper">
          <view class="message {{item.role}}-message {{item.isWelcome ? 'welcome-message' : ''}}" style="font-size: {{fontScale * 32}}rpx;">
            <!-- 助手消息使用 wemark 渲染 markdown -->
            <wemark wx:if="{{item.role === 'assistant' && !item.isWelcome}}" md="{{item.content}}" type="wemark"></wemark>
            <!-- 用户消息和欢迎消息使用普通文本 -->
            <text wx:else class="message-content" selectable user-select>{{item.content}}</text>
          </view>

          <!-- 推荐追问 (仅显示在最新的助手消息下方) -->
          <view wx:if="{{item.role === 'assistant' && item.suggestedQuestions && item.suggestedQuestions.length > 0 && item.isLatest}}" class="suggested-questions">
            <view
              wx:for="{{item.suggestedQuestions}}"
              wx:key="index"
              wx:for-item="question"
              class="suggested-question-item"
              style="font-size: {{fontScale * 28}}rpx;"
              bindtap="onClickSuggestedQuestion"
              data-question="{{question}}"
            >
              <text class="question-text">{{question}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 加载中消息 -->
      <view wx:if="{{isLoading}}" class="message-wrapper assistant-wrapper">
        <view class="message assistant-message loading">
          <text>{{loadingText}}</text>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 输入区域 -->
  <view class="input-area-wrapper">
    <view class="input-container">
      <view class="voice-button {{isRecording ? 'recording' : ''}}" bindtap="onVoiceButtonTap" bindlongpress="onVoiceStart" bindtouchend="onVoiceEnd">
        <view class="voice-icon">
          <view class="mic-stand"></view>
          <view class="mic-head"></view>
          <view wx:if="{{isRecording}}" class="recording-wave"></view>
        </view>
      </view>
      <input
        class="input-field"
        type="text"
        value="{{inputValue}}"
        placeholder="输入你的想法..."
        bindinput="onInput"
        bindconfirm="onSendMessage"
        confirm-type="send"
        adjust-position="{{true}}"
        cursor-spacing="{{cursorSpacing}}"
      />
      <view
        class="send-button {{isSending ? 'sending' : (!inputValue ? 'disabled' : '')}}"
        bindtap="onSendMessage"
      >
        <view class="arrow-icon">↑</view>
      </view>
    </view>
  </view>
</view>